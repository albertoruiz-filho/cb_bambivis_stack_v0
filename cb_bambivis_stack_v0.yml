services:
  # Serviço PostgreSQL para o Canoa Bahia CRM/ERP
  canoabahia_db:
    image: postgres:15-alpine
    container_name: canoabahia_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # MUDE ISTO PARA UMA SENHA FORTE!
    volumes:
      - canoabahia_db_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d # Para scripts de inicialização
    networks:
      - canoabahia_network # Rede interna para os serviços da aplicação

  # Serviço Directus (Backend/API e CMS)
  canoabahia_directus:
    image: directus/directus:10.10.3 # Versão estável
    container_name: canoabahia_directus
    restart: unless-stopped
    # Não expomos a porta 8055 diretamente para o host,
    # pois o NGINX Proxy Manager fará o roteamento interno.
    # ports:
    #   - "8055:8055"
    environment:
      KEY: ${KEY} # MUDE ISTO! Explicação abaixo.
      SECRET: ${SECRET} # MUDE ISTO! Explicação abaixo.
      DB_CLIENT: ${DB_CLIENT}
      DB_HOST: ${DB_HOST} # Nome do serviço do banco de dados no docker-compose
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD} # MUDE ISTO! Deve ser a mesma do canoabahia_db
      ADMIN_EMAIL: ${ADMIN_EMAIL} # Email para o primeiro usuário admin
      ADMIN_PASSWORD: ${ADMIN_PASSWORD} # MUDE ISTO! Senha para o primeiro usuário admin
      PUBLIC_URL: ${PUBLIC_URL} # URL pública que o Directus usará
      # Caching
      CACHE_ENABLED: ${CACHE_ENABLED}
      CACHE_STORE: ${CACHE_STORE} # Redis é melhor para produção, mas memory é simples para iniciar
      # CORS
      CORS_ENABLED: ${CORS_ENABLED}
      CORS_ORIGIN: ${CORS_ORIGIN} # Adicione URLs do seu frontend aqui, incluindo localhost para dev.
    depends_on:
      - canoabahia_db
    networks:
      - canoabahia_network
      - proxy # O Directus precisa estar na mesma rede 'proxy' que o NGINX Proxy Manager

  # Bootpress (previsto para o futuro)
  # Este serviço usará a mesma rede interna 'canoabahia_network' para acessar o 'canoabahia_db'
  # e poderá ser conectado ao NGINX Proxy Manager se precisar de acesso externo.
  # bootpress:
  #   image: seu_bootpress_image_aqui # Ex: bootpress/bootpress:latest
  #   container_name: bootpress
  #   restart: unless-stopped
  #   environment:
  #     DB_CLIENT: pg
  #     DB_HOST: canoabahia_db # Bootpress também pode usar o canoabahia_db
  #     DB_DATABASE: canoabahia_crm
  #     DB_USER: canoabahia_user
  #     DB_PASSWORD: am90 # Use a mesma senha do banco ou crie um usuário específico
  #     # Outras variáveis de ambiente do Bootpress
  #   depends_on:
  #     - canoabahia_db
  #   networks:
  #     - canoabahia_network
      # - proxy # Descomente se o Bootpress precisar ser acessível via NGINX Proxy Manager no futuro

volumes:
  canoabahia_db_data: # Volume para persistir os dados do PostgreSQL

networks:
  canoabahia_network: # Rede interna para serviços da aplicação (Postgres, Directus, Bootpress)
    driver: bridge
  proxy: # Rede externa para o NGINX Proxy Manager (já existe)
    external: true
    # name: proxy # Não é necessário especificar 'name' se a rede já foi criada externamente com esse nome